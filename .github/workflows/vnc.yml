name: macOS Built-in VNC with frp Tunnel

on:
  push:
    branches:
      - main

jobs:
  tunnel:
    runs-on: macos-latest
    steps:
      - name: Enable macOS built-in VNC server with password
        run: |
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -activate -configure -access -on \
            -clientopts -setvnclegacy -vnclegacy yes \
            -clientopts -setvncpw -vncpw vncpass \
            -restart -agent -privs -all

      - name: Install frpc via Homebrew
        run: brew install frpc

      - name: Create frpc.ini config
        run: |
          echo "[common]" > frpc.ini
          echo "server_addr = ${{ secrets.IP }}" >> frpc.ini
          echo "server_port = 1234" >> frpc.ini
          echo "" >> frpc.ini
          echo "[vnc]" >> frpc.ini
          echo "type = tcp" >> frpc.ini
          echo "local_ip = 127.0.0.1" >> frpc.ini
          echo "local_port = 5900" >> frpc.ini
          echo "remote_port = 5900" >> frpc.ini

      - name: Show frpc.ini content
        run: cat frpc.ini

      - name: Run frpc client
        run: frpc -c frpc.ini
